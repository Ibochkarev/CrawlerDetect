================================================================================
CrawlerDetect для MODX Revolution 3.x
================================================================================

Определение веб-краулеров (ботов/пауков) по User-Agent и заголовку http_from
и защита форм от спама без CAPTCHA. Использует библиотеку JayBizzle/Crawler-Detect.

Требования
----------
- MODX Revolution 3.x
- PHP 8.3 (минимальная версия — по требованиям MODX 3 и Crawler-Detect, например PHP 7.4+)

Установка
---------
Установите пакет через Менеджер пакетов MODX. Зависимости (vendor) уже входят
в пакет; запуск composer install на сервере не требуется.

================================================================================
Сценарии использования
================================================================================

Разработчик
  - Скрыть виджет чата/обратного звонка от ботов — не грузить лишний JS и не
    искажать статистику (условный вывод через isCrawler).
  - Не подключать тяжёлую аналитику для ботов — экономия трафика и чистые отчёты.
  - Выводить разный контент для бота и человека (упрощённая версия для краулеров).
  - В отладке смотреть имя бота в плейсхолдере crawlerdetect.matches.

Владелец сайта
  - Блокировать отправку форм ботами без CAPTCHA (контакт, заявка, подписка) —
    один preHook crawlerDetectBlock для FormIt/FetchIt.
  - Показывать «N человек на сайте» без учёта ботов (счётчик вызывать только
    при isCrawler = 0).
  - Меньше спама в почте и в админке.

Маркетинг / аналитика
  - Не учитывать ботов во внутренней статистике просмотров и в счётчиках
    «просмотров товара» / «онлайн» — корректные метрики.

E‑commerce и лиды
  - Не считать ботов в «смотрят этот товар» или «в корзине».
  - Отсекать ботов на формах «заказать звонок», «оставить заявку» — только
    реальные лиды в CRM.

Производительность
  - Не выполнять тяжёлую логику и виджеты для ботов — снижение нагрузки на сервер.

================================================================================
Сниппет isCrawler
================================================================================

Определяет, является ли текущий посетитель ботом (краулером/пауком).

Параметры
---------
userAgent (string, необязательно)
  Строка User-Agent для проверки. Если не указан, используются
  HTTP_USER_AGENT и HTTP_FROM из запроса.

Возвращаемое значение
---------------------
"1" — обнаружен бот
"0" — не бот

Дополнительно
-------------
При обнаружении бота в плейсхолдер crawlerdetect.matches записывается имя
совпадения (для отладки или вывода). Префикс плейсхолдеров можно изменить
через свойства сниппета (если реализовано).

Важно: вызывайте сниппет без кэша ([[!isCrawler]]), чтобы результат
определялся на каждый запрос.

Примеры (MODX)
--------------
Показать виджет только не-ботам:
  [[!isCrawler:eq=`0`:then=`[[$chatWidget]]`]]

Просто получить значение:
  [[!isCrawler]]

С указанием User-Agent и выводом имени бота:
  [[!isCrawler? &userAgent=`[[+custom_user_agent]]`]]
  Имя бота: [[+crawlerdetect.matches]]

Примеры (Fenom)
---------------
Виджет только для не-ботов:
  {if $modx->runSnippet('isCrawler', []) == '0'}
      {$modx->getChunk('chatWidget')}
  {/if}

С переменной:
  {set $isBot = $modx->runSnippet('isCrawler', [])}
  {if $isBot == '0'}
      {$modx->getChunk('chatWidget')}
  {/if}

С параметром userAgent и выводом имени бота:
  {$modx->runSnippet('isCrawler', ['userAgent' => $custom_user_agent])}
  {if $modx->getPlaceholder('crawlerdetect.matches')}
      Обнаружен бот: {$modx->getPlaceholder('crawlerdetect.matches')}
  {/if}

================================================================================
Сниппет crawlerDetectBlock (preHook для FormIt)
================================================================================

PreHook для FormIt: при обнаружении бота прерывает обработку формы и выводит
настраиваемое сообщение. Данные формы не сохраняются, письма не отправляются.

Использование
-------------
Добавьте имя сниппета в параметр &preHooks вызова FormIt.

Пример вызова FormIt с защитой (MODX)
-------------------------------------
[[!FormIt?
    &preHooks=`crawlerDetectBlock`
    &hooks=`email,redirect`
    &validate=`name:required,email:required:email`
    &redirectTo=`[[*id]]`
    &emailTo=`[[++emailsender]]`
    &emailSubject=`Обратная связь`
]]
[[+fi.validation_error_message]]
<form action="[[~[[*id]]]]" method="post">
    <input type="text" name="name" value="[[+fi.name]]" />
    <input type="email" name="email" value="[[+fi.email]]" />
    <button type="submit" name="submit">Отправить</button>
</form>

Пример вызова FormIt с защитой (Fenom)
--------------------------------------
{$modx->runSnippet('FormIt', [
    'preHooks' => 'crawlerDetectBlock',
    'hooks' => 'email,redirect',
    'validate' => 'name:required,email:required:email',
    'redirectTo' => $modx->resource->id,
    'emailTo' => $modx->getOption('emailsender'),
    'emailSubject' => 'Обратная связь'
])}
{if $modx->getPlaceholder('fi.validation_error_message')}
    <div class="error">{$modx->getPlaceholder('fi.validation_error_message')}</div>
{/if}
<form action="{$modx->makeUrl($modx->resource->id)}" method="post">
    <input type="text" name="name" value="{$modx->getPlaceholder('fi.name')}" />
    <input type="email" name="email" value="{$modx->getPlaceholder('fi.email')}" />
    <button type="submit" name="submit">Отправить</button>
</form>

Сообщение при блокировке ботом выводится через стандартный плейсхолдер
FormIt fi.validation_error_message. Текст задаётся в системных настройках
дополнения CrawlerDetect.

================================================================================
Интеграция с FetchIt
================================================================================

FetchIt обрабатывает формы через FormIt на сервере. Чтобы защитить форму,
отправляемую через FetchIt, укажите в конфигурации обработки формы вызов
FormIt с параметром &preHooks="crawlerDetectBlock" (как в примерах выше).
Отдельной настройки или кода для FetchIt не требуется — при блокировке ботом
ответ FormIt (ошибка валидации) вернётся через Fetch API, и пользователь увидит
сообщение из настроек CrawlerDetect.

================================================================================
Системные настройки (namespace crawlerdetect)
================================================================================

- Текст сообщения при блокировке формы ботом (по умолчанию — нейтральное
  сообщение, например «Не удалось отправить форму. Попробуйте позже.»).
- Опция включения/выключения логирования заблокированных попыток в лог MODX.

================================================================================
Счётчик посетителей без ботов (опционально)
================================================================================

Чтобы не учитывать ботов в счётчике «N человек на сайте», вызывайте сниппет
счётчика только когда isCrawler возвращает 0.

MODX:
  [[!isCrawler:eq=`0`:then=`[[!yourVisitorCounterSnippet]]`]]

Fenom:
  {if $modx->runSnippet('isCrawler', []) == '0'}
      {$modx->runSnippet('yourVisitorCounterSnippet', [])}
  {/if}

================================================================================
Обновление библиотеки JayBizzle/Crawler-Detect
================================================================================

Обновление библиотеки выполняется вместе с релизом новой версии дополнения
CrawlerDetect. Пользователю достаточно обновить пакет CrawlerDetect через
Менеджер пакетов MODX — актуальная версия Crawler-Detect уже входит в пакет.
Отдельно обновлять библиотеку на сервере не нужно.

================================================================================
Ссылки
================================================================================
- JayBizzle/Crawler-Detect: https://github.com/JayBizzle/Crawler-Detect
- FormIt (MODX 3.x): https://docs.modx.com/3.x/ru/extras/formit
- FetchIt: https://docs.modx.pro/components/fetchit/
